{% extends 'layout.html' %}
{% block content %}
<div id="table-search" class="col-xs-12">
    <div class="col-xs-12 text-left">
        <span>T&euml;
            {%if count < 10%}
                shfaqura {{count}} dokumente
            {%else%}
                shfaqura <span id="tableLength"></span> nga {{count}} dokumente
            {%endif%}
        </span>
    </div>
    <table class="table table-striped table-bordered" id="searchTable">
        <thead>
            <tr>
                <th>Emri i Biznesit</th>
                <th>Statusi i Biznesit</th>
                <th>Komuna</th>
                <th>Pronar&euml;t</th>
                <th>Personat e autorizuar</th>
            </tr>
        </thead>
        <tbody>
            {%if count != 0%}
                {% for doc in search_result %}
                <tr>
                    <td><a href="{{doc['arbkUrl']}}">{{doc['name']}}</a></td>
                    <td>{{doc['status']}}</td>
                    <td>{{doc['municipality']['municipality']}}</td>
                    <td>
                        {% for owner in doc['owners'] %}
                        <a href="{{url_for('main.profile', status="owner", person=owner['name'])}}">{{owner['name']}}</a><br/>
                        {% endfor %}
                    </td>
                    <td>
                        {% for auth in doc['authorized'] %}
                        <a href="{{url_for('main.profile', status="authorized", person=auth['name'])}}">{{auth['name']}}</a><br/>
                        {% endfor %}
                    </td>
                </tr>
                {% endfor %}
            {%else%}
                <tr>
                    <td colspan="5" class="text-center">
                        Nuk u gjet ansj&euml; dokument!
                    </td>
                </tr>
            {%endif%}
        </tbody>
    </table>
    <div class="col-xs-12 text-center">
        <ul id="pagination-demo" class="pagination-sm"></ul>
    </div>
</div>
<script src="{{url_for('static', filename='js/jquery.twbsPagination.js')}}"></script>
<script type="text/javascript">
    $(document).ready(function() {
        var urlParam = parseInt(getUrlParameter('page'));
        var municipality = getUrlParameter('municipality');
        var biz_status = getUrlParameter('biz-status');
        var person_status = getUrlParameter('person-status');
        var person = getUrlParameter('person');
        var business = getUrlParameter('business');
        $('#tableLength').html($('#searchTable tbody tr').length);
        if (isNaN(parseFloat(urlParam))) {
            urlParam = 1;
        }else {
            $('html, body').stop().animate({
                scrollTop: ($('#searchTable').offset().top - 150)
            }, 1250, 'easeInOutExpo');
        }
        event.preventDefault();
        if (person_status == undefined && biz_status == undefined && municipality == undefined) {
            person_status = "any";
            biz_status = "any";
            municipality = "any";
        }
        else if (person_status == null && biz_status == null && municipality == null) {
            person_status = "any";
            biz_status = "any";
            municipality = "any";
            $('#placesSearch').val("any");
            $('#biz_statusSearch').val("any");
            $('#typeSearch').val("any");
        }else{
            $('#placesSearch').val(municipality);
            $('#biz_statusSearch').val(biz_status);
            $('#typeSearch').val(person_status);
            $('#person-search-field').val(person);
            $('#biz-search-field').val(business);
        }
        if (person == undefined && business == undefined) {
            person = "";
            business = "";
        }
        if (parseInt("{{count}}") != 0) {
            $('#pagination-demo').twbsPagination({
                startPage: urlParam,
                totalPages: Math.ceil(parseInt("{{count}}")/parseInt("{{items_per_page}}")),
                visiblePages: 7,
                first:"E para",
                prev:"Prapa",
                next:"Perpara",
                last:"E fundit",
                initiateStartPageClick: false,
                onPageClick: function (event, page) {
                    window.location.href = "?page="+page+"&municipality="+municipality+"&biz-status="+biz_status+"&person-status="+person_status+"&person="+person+"&business="+business+"";
                }
            });
        }
    });
    function getUrlParameter(sParam) {
        var sPageURL = decodeURIComponent(window.location.search.substring(1)),
            sURLVariables = sPageURL.split('&'),
            sParameterName,
            i;

        for (i = 0; i < sURLVariables.length; i++) {
            sParameterName = sURLVariables[i].split('=');

            if (sParameterName[0] === sParam) {
                return sParameterName[1] === undefined ? true : sParameterName[1];
            }
        }
    }
    function search() {
        // service
        var municipality = $('#placesSearch').val();
        var biz_status = $('#biz_statusSearch').val();
        var person_status = $('#typeSearch').val();
        var person = $('#person-search-field').val();
        var business = $('#biz-search-field').val();
        if (person_status == undefined && biz_status == undefined && municipality == undefined) {
            person_status = "any";
            biz_status = "any";
            municipality = "any";
        }
        if (person_status == null && biz_status == null && municipality == null) {
            person_status = "any";
            biz_status = "any";
            municipality = "any";
        }
        window.location.href = "?page=1&municipality="+municipality+"&biz-status="+biz_status+"&person-status="+person_status+"&person="+person+"&business="+business+"";
    }
</script>
{% endblock %}
