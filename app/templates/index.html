{% extends 'layout.html' %}
{% block content %}
<div id="table-search" class="col-xs-12">
    <div class="col-xs-12 text-left">
        <span>T&euml;
            {%if count < 10%}
                shfaqura {{count}} dokumente
            {%else%}
                shfaqura <span id="tableLength"></span> nga {{count}} dokumente
            {%endif%}
        </span>
    </div>
    <div class="col-xs-12" style="overflow-x:auto">
        <table class="table table-striped table-bordered" id="searchTable">
            <thead>
                <tr>
                    <th>Emri i Biznesit</th>
                    <th>Statusi i Biznesit</th>
                    <th>Komuna</th>
                    <th>Pronar&euml;t</th>
                    <th>Personat e autorizuar</th>
                </tr>
            </thead>
            <tbody>
                {%if count != 0%}
                {% for doc in search_result %}
                <tr>
                    <td><a href="{{doc['arbkUrl']}}">{{doc['name']}}</a></td>
                    <td>{{doc['status']}}</td>
                    <td>{{doc['municipality']['municipality']}}</td>
                    <td>
                        {% for owner in doc['owners'] %}
                        <a href="{{url_for('main.profile', status="owner", person=owner['name'])}}">{{owner['name']}}</a><br/>
                        {% endfor %}
                    </td>
                    <td>
                        {% for auth in doc['authorized'] %}
                        <a href="{{url_for('main.profile', status="authorized", person=auth['name'])}}">{{auth['name']}}</a><br/>
                        {% endfor %}
                    </td>
                </tr>
                {% endfor %}
                {%else%}
                <tr>
                    <td colspan="5" class="text-center">
                        Nuk u gjet ansj&euml; dokument!
                    </td>
                </tr>
                {%endif%}
            </tbody>
        </table>
    </div>
    <div class="col-xs-12 text-center">
        <ul id="pagination-demo" class="pagination-sm"></ul>
    </div>
</div>
<script src="{{url_for('static', filename='js/jquery.twbsPagination.js')}}"></script>
<script src="{{url_for('static', filename='js/charReplace.js')}}"></script>
<script type="text/javascript">
    $(document).ready(function() {
        $('#search-form').keydown(function(e) {
            if (e.keyCode == 13) {
                search();
            }
        });
        var urlParam = parseInt(getUrlParameter('page'));
        var municipality = getUrlParameter('municipality');
        var biz_status = getUrlParameter('biz-status');
        var person_status = getUrlParameter('person-status');
        var person = getUrlParameter('person');
        var business = getUrlParameter('business');
        $('#tableLength').html($('#searchTable tbody tr').length);
        if (isNaN(parseFloat(urlParam))) {
            urlParam = 1;
        }else {
            $('html, body').stop().animate({
                scrollTop: ($('#searchTable').offset().top - 150)
            }, 600, 'easeInOutExpo');
        }
        if (person_status == null || person_status == undefined){
            person_status = "any";
            $('#typeSearch').val("any");
        }else {
            $('#typeSearch').val(person_status);
        }
        if(biz_status == null || biz_status == undefined){
            biz_status = "any";
            $('#biz_statusSearch').val("any");
        }else {
            $('#biz_statusSearch').val(biz_status);
        }
        if(municipality == null || municipality == undefined){
            municipality = "any";
            $('#placesSearch').val("any");
        }else {
            $('#placesSearch').val(municipality);
        }
        if (person == undefined && business == undefined) {
            person = "";
            business = "";
        }
        $('#person-search-field').val(person);
        $('#biz-search-field').val(business);
        var totPages = Math.ceil(parseInt("{{count}}")/parseInt("{{items_per_page}}"));
        person = replaceChars(person);
        business = replaceChars(business);
        if (totPages < urlParam) {
            $('#table-search').html('<div class="col-xs-12 text-center"><span id="pageNotFound">Faqja nuk u gjet!</span></div>')
        }
        if (parseInt("{{count}}") != 0 && totPages >= urlParam) {
            $('#pagination-demo').twbsPagination({
                startPage: urlParam,
                totalPages: totPages,
                visiblePages: 7,
                first:"E para",
                prev:"Prapa",
                next:"P\xebrpara",
                last:"E fundit",
                initiateStartPageClick: false,
                onPageClick: function (event, page) {
                    window.location.href = "?page="+page+"&municipality="+municipality+"&biz-status="+biz_status+"&person-status="+person_status+"&person="+person+"&business="+business+"";
                }
            });
        }
    });
    function getUrlParameter(sParam) {
        var sPageURL = decodeURIComponent(window.location.search.substring(1)),
            sURLVariables = sPageURL.split('&'),
            sParameterName,
            i;

        for (i = 0; i < sURLVariables.length; i++) {
            sParameterName = sURLVariables[i].split('=');

            if (sParameterName[0] === sParam) {
                return sParameterName[1] === undefined ? true : sParameterName[1];
            }
        }
    }
    function search() {
        // service
        var municipality = $('#placesSearch').val();
        var biz_status = $('#biz_statusSearch').val();
        var person_status = $('#typeSearch').val();
        var person = $('#person-search-field').val();
        var business = $('#biz-search-field').val();
        if (person_status == undefined)person_status = "any";
        if(biz_status === undefined)biz_status = "any";
        if(municipality == undefined)municipality = "any";
        if (person_status == null)person_status = "any";
        if(biz_status === null)biz_status = "any";
        if(municipality == null)municipality = "any";
        person = replaceChars(person);
        business = replaceChars(business);
        window.location.href = "?page=1&municipality="+municipality+"&biz-status="+biz_status+"&person-status="+person_status+"&person="+person+"&business="+business+"";
    }
</script>
{% endblock %}
