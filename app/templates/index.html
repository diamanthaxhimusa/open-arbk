{% extends 'layout.html' %}
{% block content %}
<div id="table-search">
    <div class="overllaySearch">
        <div class="loader-gif">
            <img src="{{url_for('static', filename='img/preloader.gif')}}" alt="">
        </div>
    </div>
    <table class="table table-striped" id="searchTable">
        <thead>
            <tr>
                <th>Emri i Biznesit</th>
                <th>Statusi i Biznesit</th>
                <th>Komuna</th>
                <th>Pronar&euml;t</th>
                <th>T&euml; autorizuar&euml;t</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>
<script type="text/javascript">
    $(document).ready( function () {
        $('#searchBtn').on('click', function() {
            var target = $('#service');
            target = target.length ? target : $('[name=' + this.hash.slice(1) +']');
            if (target.length) {
                $('html,body').animate({
                    scrollTop: target.offset().top - 100
                }, 1000);
                return false;
            }
        })
        var oTable;
        var newRowData = $.ajax({
           url: "{{ url_for('main.search_result') }}", //this is the submit URL
           type: 'GET',
           dataType: 'json',
           async: false,
        }).responseJSON;
        init_table(newRowData);
        var height = $('#table-search').height();
        var width = $('#table-search').width();
        $('.overllaySearch').attr('style', 'height:'+height+'px;width:'+width+'px;');
        $(".overllaySearch").hide();
    });
    function init_table(newRowData) {
        oTable = $('#searchTable').dataTable({
           "aaData": newRowData,
           searching: false,
           responsive: true,
           "aoColumns": [
               {"mData": "name",
                   "render": function (data, type, row) {
                       var res = '<a href="'+row.arbkUrl+'">'+data+'</a>';
                       return res
                    }
                },
               {"mData": "status"},
               {"mData": "municipality.municipality"},
               {"mData": "owners",
                   "render": function (data) {
                       result = '';
                   $.each(data, function(key, val) {
                       result += '<a href="{{url_for('main.profile', status="owner", person="")}}'+val.name+'">'+val.name+'</a><br/>';
                   });
                    return result
                   }
               },
               {"mData": "authorized",
                   "render": function (data) {
                       result = '';
                   $.each(data, function(key, val) {
                       result += '<a href="{{url_for('main.profile', status="authorized", person="")}}'+val.name+'">'+val.name+'</a><br/>';
                   });
                    return result
                   }
               }
           ],
           "language": {
             "lengthMenu": "Të shfaqur  _MENU_  persona",
             "zeroRecords": "Asgjë nuk u gjet!",
             "info": "Faqja _PAGE_ nga _PAGES_",
             "infoEmpty": "Nuk ka rezultate!",
             "infoFiltered": "(filtruar nga _MAX_ totali i rezultateve)",
             "paginate": {
                 "previous": "Prapa",
                 "next": "Para"
             }
            }
        });
    };
    function search() {
        // service
         $.ajax({
            url: "{{ url_for('main.search_result') }}", //this is the submit URL
            type: 'POST',
            dataType: 'json',
            data : {
                municipality : $('#placesSearch').val(),
                biz_status : $('#biz_statusSearch').val(),
                person_status : $('#typeSearch').val(),
                person : $('#person-search-field').val(),
                business : $('#biz-search-field').val()
            },
            beforeSend: function(){
                $(".overllaySearch").show();
            },
            success: function (data) {
                console.log("writing data in table");
                oTable.fnClearTable();
                if (data.length != 0 && data != null && data != undefined){
                    oTable.fnAddData(data);
                }
                oTable.fnDraw();
                $(".overllaySearch").hide();
            }
        });
    }

</script>
{% endblock %}
